// Initialize Supabase client
function initializeSupabase() {
  const supabaseUrl = 'https://knlovzpoxlozjgkgttou.supabase.co'; // Replace with your Supabase URL
  const supabaseKey = 'your-supabase-anon-key'; // Replace with your Supabase Anon key
  return supabase.createClient(supabaseUrl, supabaseKey);
}

// Check if user is authenticated
async function checkAuth() {
  const supabase = initializeSupabase();
  const { data: { user }, error } = await supabase.auth.getUser();

  const loadingMessage = document.getElementById('loading-message');
  const dashboardContainer = document.getElementById('dashboard');
  const usernameSpan = document.getElementById('username');

  if (user) {
    usernameSpan.textContent = user.email;
    dashboardContainer.style.display = 'block';
    loadingMessage.style.display = 'none';
    await fetchCoinBalance(user.id); // Use user.id (UUID) here
  } else {
    console.log("User not authenticated, redirecting to login.");
    window.location.href = '/pages/login.html';
  }
}

// Fetch coin balance from Supabase using user_id
async function fetchCoinBalance(userId) {
  const supabase = initializeSupabase();
  const { data, error } = await supabase
    .from('user_rewards')
    .select('coins')
    .eq('user_id', userId) // Use user_id (UUID) here
    .single();

  if (error) {
    console.error('Error fetching coin balance:', error.message);
  } else {
    document.getElementById('coinBalance').textContent = data.coins;
  }
}

// Reward coins after watching the video
let videoTimer;
let timeLeft = 30; // 30 seconds timer

function startVideo() {
  const video = document.getElementById('videoPlayer');
  const timerDisplay = document.getElementById('timer');
  const startButton = document.getElementById('startVideoButton');
  
  // Disable the button while watching the video
  startButton.disabled = true;

  // Start the timer countdown
  video.play();
  videoTimer = setInterval(function() {
    timeLeft--;
    timerDisplay.textContent = `Time left: ${timeLeft}s`;

    if (timeLeft <= 0) {
      clearInterval(videoTimer); // Stop the timer
      rewardCoins(); // Reward coins after 30 seconds
      startButton.disabled = false; // Re-enable the button
      timeLeft = 30; // Reset the timer
      timerDisplay.textContent = ''; // Clear timer display
    }
  }, 1000);
}

// Update the user's coin balance after watching the video
async function rewardCoins() {
  const supabase = initializeSupabase();
  const userId = (await supabase.auth.getUser()).data.user.id; // Get user.id (UUID)
  const coinsToAdd = 5; // Reward 5 coins for watching the video

  // Update the coins in the database
  const { data, error } = await supabase
    .from('user_rewards')
    .select('coins')
    .eq('user_id', userId) // Use user_id (UUID) here
    .single();

  if (error) {
    console.error('Error fetching coin balance:', error.message);
    return;
  }

  const newBalance = data.coins + coinsToAdd;
  const { updateError } = await supabase
    .from('user_rewards')
    .update({ coins: newBalance })
    .eq('user_id', userId); // Use user_id (UUID) here

  if (updateError) {
    console.error('Error updating coin balance:', updateError.message);
  } else {
    document.getElementById('coinBalance').textContent = newBalance;
  }
}

// Log out user
document.getElementById("logoutButton").addEventListener('click', async () => {
  const supabase = initializeSupabase();
  const { error } = await supabase.auth.signOut();
  if (error) {
    console.error('Error logging out:', error.message);
  } else {
    window.location.href = 'login.html'; // Redirect after logout
  }
});

// Check authentication when the page loads
window.onload = checkAuth;
